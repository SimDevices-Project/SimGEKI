name: Auto-Build-Firmware
run-name: Building Firmware...
on:
  push:
    branches: [ main, master ]  # Only active on main branch for nightly builds
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering
jobs:
  build-firmware:
    name: Build Multi-Target Firmware
    runs-on: windows-2022
    strategy:
      matrix:
        target: [SimGETRO_Public, SimGETRO_EarlyHardware]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Clean build artifacts
        run: |
          make clean_all
      
      - name: Build firmware for ${{ matrix.target }}
        run: |
          make TARGET=${{ matrix.target }} all -j4
      
      - name: Create output directory and copy firmware files
        run: |
          mkdir "output-${{ matrix.target }}"
          Copy-Item "./build/${{ matrix.target }}/SimGEKI.bin" -Destination "./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.bin" -Force
          Copy-Item "./build/${{ matrix.target }}/SimGEKI.hex" -Destination "./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.hex" -Force
        shell: pwsh
      
      - name: Upload firmware to artifacts (bin)
        uses: actions/upload-artifact@v4
        with:
          name: SimGEKI-${{ matrix.target }}_firmware_bin
          path: ./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.bin
          retention-days: 90
      
      - name: Upload firmware to artifacts (hex)
        uses: actions/upload-artifact@v4
        with:
          name: SimGEKI-${{ matrix.target }}_firmware_hex
          path: ./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.hex
          retention-days: 90
      
      - name: Upload files to release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') && !contains(github.ref, 'nightly-builds')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.bin
            ./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.hex

  # Nightly builds job - collect all artifacts and update nightly-builds release
  update-nightly-builds:
    name: Update Nightly Builds
    runs-on: windows-2022
    needs: build-firmware
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./nightly-artifacts
      
      - name: Prepare nightly release files
        run: |
          mkdir "nightly-release"
          # Copy all 'bin' & 'hex' files into 'nightly-release' directory
          Get-ChildItem -Path "./nightly-artifacts" -Recurse -Include "*.bin", "*.hex" | ForEach-Object {
            Copy-Item $_.FullName -Destination "./nightly-release/" -Force
          }
          # Show file list for debugging
          Write-Host "Files prepared for nightly release:"
          Get-ChildItem -Path "./nightly-release/"
        shell: pwsh
      
      - name: Delete existing nightly-builds tag and release
        continue-on-error: true
        run: |
          # Try to delete local tag first
          git tag -d nightly-builds 2>/dev/null || echo "Local tag not found"
          # Delete remote tag if it exists
          git push origin --delete nightly-builds 2>/dev/null || echo "Remote tag not found or already deleted"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create/Update nightly-builds tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # Create a new tag pointing to the current commit
          git tag nightly-builds ${{ github.sha }}
          git push origin nightly-builds --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create/Update nightly-builds release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: nightly-builds
          name: "SimGEKI firmeware Nightly Builds"
          body: |
            # Welcome to the SimGEKI Nightly Builds!

            ## What is this?

            Nightly Builds are the latest development versions of the SimGEKI firmware, automatically built with every commit to the main branch. This means you always have access to the most recent changes and features, but please note that these builds are not guaranteed to be stable.

            ## How to use?

            Download the firmware files from the assets below and flash them to your SimGEKI device. Make sure to check the compatibility with your hardware version. To flash the firmware, you can refer to the following link for instructions [Update Firmware](https://sim.bysb.net/#/simgeki2/configs/update-firmware/)

            ## Build Information
            This release is automatically generated from the latest commit on the main branch. It includes all changes made since the last nightly build.

            üìÖ **Build Date**: ${{ github.event.head_commit.timestamp }}
            üî® **Commit**: ${{ github.sha }}
            üë§ **Author**: ${{ github.event.head_commit.author.name }}
            üí¨ **Message**: ${{ github.event.head_commit.message }}
            
            ---
            
            This release is automatically updated with every commit to the main branch.
            
            **Available firmware variants:**
            - `SimGEKI-SimGETRO_Public.bin/hex` - Public release version
            - `SimGEKI-SimGETRO_EarlyHardware.bin/hex` - Early hardware version
            
            ‚ö†Ô∏è **Note**: These are development builds and may be unstable.
          prerelease: true
          files: |
            ./nightly-release/*
