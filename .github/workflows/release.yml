name: Auto-Build-Firmware
run-name: Building Firmware...
on:
  push:
    branches: [ main, master ]  # Only active on main branch for nightly builds
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering
jobs:
  build-firmware:
    name: Build Multi-Target Firmware
    runs-on: windows-2022
    permissions:
      contents: write
      actions: read
    strategy:
      matrix:
        target: [SimGETRO_Public, SimGETRO_EarlyHardware]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Clean build artifacts
        run: |
          make clean_all
      
      - name: Build firmware for ${{ matrix.target }}
        run: |
          make TARGET=${{ matrix.target }} all -j4
      
      - name: Create output directory and copy firmware files
        run: |
          mkdir "output-${{ matrix.target }}"
          Copy-Item "./build/${{ matrix.target }}/SimGEKI.bin" -Destination "./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.bin" -Force
          Copy-Item "./build/${{ matrix.target }}/SimGEKI.hex" -Destination "./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.hex" -Force
        shell: pwsh
      
      - name: Upload firmware to artifacts (bin)
        uses: actions/upload-artifact@v4
        with:
          name: SimGEKI-${{ matrix.target }}_firmware_bin
          path: ./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.bin
          retention-days: 90
      
      - name: Upload firmware to artifacts (hex)
        uses: actions/upload-artifact@v4
        with:
          name: SimGEKI-${{ matrix.target }}_firmware_hex
          path: ./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.hex
          retention-days: 90
      
      - name: Upload files to release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') && !contains(github.ref, 'nightly-builds')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.bin
            ./output-${{ matrix.target }}/SimGEKI-${{ matrix.target }}.hex

  # Nightly builds job - collect all artifacts and update nightly branch
  update-nightly-builds:
    name: Update Nightly Branch
    runs-on: windows-2022
    permissions:
      contents: write
      actions: read
    needs: build-firmware
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./nightly-artifacts
      
      - name: Prepare nightly release files
        run: |
          mkdir "nightly-release"
          # Copy all 'bin' & 'hex' files into 'nightly-release' directory
          Get-ChildItem -Path "./nightly-artifacts" -Recurse -Include "*.bin", "*.hex" | ForEach-Object {
            Copy-Item $_.FullName -Destination "./nightly-release/" -Force
          }
          # Show file list for debugging
          Write-Host "Files prepared for nightly release:"
          Get-ChildItem -Path "./nightly-release/"
        shell: pwsh
      
      - name: Create/Update nightly branch and commit files
        run: |
          # Configure git user
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Create or switch to nightly branch
          Write-Host "Creating/switching to nightly branch..."
          git checkout -B nightly
          
          # Copy firmware files to the root for easy access
          Write-Host "Copying firmware files to nightly branch..."
          Copy-Item "./nightly-release/*" -Destination "./" -Force
          
          # Add firmware files to git
          git add *.bin *.hex
          
          # Check if there are changes to commit
          $changes = git diff --staged --name-only
          if ($changes) {
            Write-Host "Committing firmware files..."
            git commit -m "ğŸŒ™ Nightly Build - Auto-updated
            
            ğŸ“… Build Date: ${{ github.event.head_commit.timestamp }}
            ğŸ”¨ Commit: ${{ github.sha }}
            ğŸ‘¤ Author: ${{ github.event.head_commit.author.name }}
            ğŸ’¬ Message: ${{ github.event.head_commit.message }}

            Available firmware variants:
            - SimGEKI-SimGETRO_Public.bin/hex - Public release version  
            - SimGEKI-SimGETRO_EarlyHardware.bin/hex - Early hardware version"
            
            # Push the nightly branch
            Write-Host "Pushing nightly branch to remote..."
            git push origin nightly --force
          } else {
            Write-Host "No changes to commit"
          }
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Delete existing nightly release
        continue-on-error: true
        run: |
          # ä½¿ç”¨ GitHub CLI åˆ é™¤ç°æœ‰çš„ nightly releaseï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          Write-Host "Attempting to delete existing nightly release..."
          gh release delete nightly --yes 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Existing nightly release deleted"
          } else {
            Write-Host "No existing nightly release found or already deleted"
          }
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create new nightly release with updated info
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: nightly
          target_commitish: nightly
          name: "SimGEKI Firmware Nightly Builds (Updated ${{ github.event.head_commit.timestamp }})"
          body: |
            # ğŸŒ™ SimGEKI Nightly Builds - Auto Updated!

            ## â„¹ï¸ What is this?

            Nightly Builds are the latest development versions of the SimGEKI firmware, automatically built with every commit to the main branch. This means you always have access to the most recent changes and features, but please note that these builds are not guaranteed to be stable.

            ## ğŸš€ How to use?

            Download the firmware files from the assets below and flash them to your SimGEKI device. Make sure to check the compatibility with your hardware version. 
            
            ğŸ“– **Flash Instructions**: [Update Firmware Guide](https://sim.bysb.net/#/simgeki2/configs/update-firmware/)

            ## ğŸ“‹ Latest Build Information

            ï¿½ **Build Time**: ${{ github.event.head_commit.timestamp }}  
            ğŸ”¨ **Source Commit**: [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})  
            ğŸ‘¤ **Author**: ${{ github.event.head_commit.author.name }}  
            ï¿½ **Commit Message**: 
            ```
            ${{ github.event.head_commit.message }}
            ```

            ## ğŸ“¦ Available Firmware Variants

            | Variant | Description | Download |
            |---------|-------------|----------|
            | **SimGETRO_Public** | Public release version | [ğŸ“¥ BIN](https://github.com/${{ github.repository }}/releases/download/nightly/SimGEKI-SimGETRO_Public.bin) / [ğŸ“¥ HEX](https://github.com/${{ github.repository }}/releases/download/nightly/SimGEKI-SimGETRO_Public.hex) |
            | **SimGETRO_EarlyHardware** | Early hardware version | [ğŸ“¥ BIN](https://github.com/${{ github.repository }}/releases/download/nightly/SimGEKI-SimGETRO_EarlyHardware.bin) / [ğŸ“¥ HEX](https://github.com/${{ github.repository }}/releases/download/nightly/SimGEKI-SimGETRO_EarlyHardware.hex) |

            ## âš ï¸ Important Notes

            - ğŸ”„ **Auto-Updated**: This release is automatically updated with every commit to the main branch
            - ğŸ§ª **Development Build**: These builds may be unstable and are intended for testing
            - ğŸ“… **Last Updated**: ${{ github.event.head_commit.timestamp }}
            - ğŸŒ **Repository**: [SimDevices-Project/SimGEKI](https://github.com/${{ github.repository }})

            ---
            
            ğŸ’¡ **Tip**: For stable releases, check the [official releases](https://github.com/${{ github.repository }}/releases) page.
          prerelease: true
          files: |
            ./nightly-release/*
